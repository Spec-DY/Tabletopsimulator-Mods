-- 公共位置表
local commonPositions = {
    white = {{-14,2,-23.05},{5.37,2,-6.93},{5.32,2,-15.56},{-35,2,-22.22},{-35,2,-6},{-21.00, 2.50, -8.00},{-18.00, 2.49, -8.00},{-15.00, 2.49, -8.00},{-12.00, 2.49, -8.00},{-9.00, 2.48, -8.00}},
    blue = {{50.39, 2, -23.11},{70.74, 2, -6.58},{71.17, 2, -15.68},{29.57, 2, -22.29},{30.00, 2, -6.77},{42.00, 2.20, -9.00},{45.00, 2.19, -9.00},{48.00, 2.19, -9.00},{51.00, 2.18, -9.00},{54.00, 2.18, -9.00}},
    yellow = {{50.59, 2, 24.82},{71.03, 2, 9.54},{71.25, 2, 18.03},{29.74, 2, 24.11},{30.30, 2, 8.10},{54.00, 2.19, 11.00},{51.00, 2.19, 11.00},{48.00, 2.19, 11.00},{45.00, 2.20, 11.00},{42.00, 2.20, 11.00}},
    red = {{-13.09, 2, 26.10},{7.33, 2, 10.82},{7.56, 2, 19.31},{-34.12, 2, 25.33},{-34.35, 2, 8.80},{-8.00, 2.27, 12.00},{-11.00, 2.28, 12.00},{-14.00, 2.28, 12.00},{-17.00, 2.28, 12.00},{-20.00, 2.29, 12.00}}
}

-- 玩家颜色的旋转方向表
local rotations = {
    white = { base = {0, 180, 0}, token = {0, 360, 0} },
    blue = { base = {0, 180, 0}, token = {0, 360, 0} },
    yellow = { base = {0, 0, 360}, token = {0, 180, 0} },
    red = { base = {0, 0, 360}, token = {0, 180, 0} }
}

-- 角色基本信息 (简化版)
local heroData = {
    -- 格式: [key] = { guid, name, 按钮宽度增加?, token位置表 }
    ninja = { "00084c", "忍者", false, {
        white = {{-34.00, 1.59, -13.50},{-34.00, 1.59, -17.00},{-34.00, 1.59, -21.00}},
        blue = {{30.60, 1.52, -13.63},{30.60, 1.52, -16.97},{30.60, 1.52, -21.06}},
        yellow = {{28.60, 1.53, 15.50},{28.60, 1.53, 18.78},{28.60, 1.53, 22.90}},
        red = {{-35.24, 1.62, 16.70},{-35.19, 1.62, 19.95},{-35.20, 1.62, 24.13}}
    }},
    paladin = { "678675", "圣骑士", false, {
        white = {{-34.00, 1.59, -13.45},{-34.00, 1.59, -17.20},{-34.00, 1.59, -21.45},{-34.00, 1.59, -24.77},{-34.00, 1.59, -28.2}},
        blue = {{30.60, 1.52, -13.30},{30.60, 1.52, -17.22},{30.60, 1.52, -21.24},{30.60, 1.52, -24.69},{30.60, 1.52, -28.19}},
        yellow = {{28.60, 1.53, 15.11},{28.60, 1.53, 19.08},{28.60, 1.53, 23.08},{28.60, 1.53, 26.50},{28.60, 1.53, 30.08}},
        red = {{-35.24, 1.62, 16.31},{-35.19, 1.62, 20.25},{-35.20, 1.62, 24.27},{-35.24, 1.62, 27.69},{-35.19, 1.62, 31.34}}
    }},
    seraph = { "382a31", "炽天使", false, {
        white = {{-34.16, 1.59, -12.90},{-34.09, 1.59, -17.63},{-34.08, 1.59, -22.37},{-34.09, 1.59, -25.56},{-34.13, 1.59, -29.02}},
        blue = {{30.43, 1.52, -12.97},{30.45, 1.52, -17.71},{30.52, 1.52, -22.46},{30.45, 1.52, -25.63},{30.42, 1.52, -29.04}},
        yellow = {{28.90, 1.53, 14.78},{28.88, 1.53, 19.86},{28.85, 1.53, 24.54},{28.92, 1.53, 27.43},{28.89, 1.53, 30.84}},
        red = {{-34.95, 1.62, 16.03},{-34.97, 1.62, 20.72},{-35.00, 1.62, 25.44},{-35.00, 1.62, 28.63},{-34.96, 1.62, 32.02}}
    }},
    shadow = { "303f58", "暗影贼", false, {
        white = {{-33.85, 1.59, -13.20},{-33.84, 1.59, -18.18},{-33.82, 1.59, -22.28}},
        blue = {{30.71, 1.52, -13.28},{30.71, 1.52, -18.22},{30.73, 1.52, -22.34}},
        yellow = {{28.63, 1.53, 15.09},{28.63, 1.53, 20.05},{28.60, 1.53, 24.17}},
        red = {{-35.24, 1.62, 16.26},{-35.24, 1.62, 21.28},{-35.25, 1.62, 25.36}}
    }},
    vamp = { "05eceb", "吸血鬼", false, {
        white = {{-34.00, 1.59, -13.11},{-34.00, 1.59, -19.96},{-34.00, 1.59, -23.53}},
        blue = {{30.60, 1.52, -13.25},{30.60, 1.52, -20.05},{30.60, 1.52, -23.58}},
        yellow = {{28.73, 1.53, 15.07},{28.69, 1.53, 21.86},{28.76, 1.53, 25.42}},
        red = {{-35.12, 1.62, 16.23},{-35.14, 1.62, 23.09},{-35.15, 1.62, 26.65}}
    }},
    samurai = { "cf5cd1", "武士", false, {
        white = {{-34.00, 1.59, -13.50},{-34.00, 1.59, -17.00},{-34.00, 1.59, -21.00}},  -- 使用忍者的相同位置
        blue = {{30.60, 1.52, -13.63},{30.60, 1.52, -16.97},{30.60, 1.52, -21.06}},
        yellow = {{28.60, 1.53, 15.50},{28.60, 1.53, 18.78},{28.60, 1.53, 22.90}},
        red = {{-35.24, 1.62, 16.70},{-35.19, 1.62, 19.95},{-35.20, 1.62, 24.13}}
    }},
    pirate = { "947631", "海盗", false, {
        white = {{-31.96, 1.59, -14.00},{-34.25, 1.59, -19.43},{-34.17, 1.59, -25.73},{-34.17, 1.59, -29.17}},
        blue = {{32.60, 1.52, -14.14},{30.34, 1.52, -19.53},{30.41, 1.52, -25.80},{30.38, 1.52, -29.26}},
        yellow = {{26.69, 1.53, 15.95},{28.98, 1.53, 21.32},{28.96, 1.53, 27.62},{28.97, 1.53, 31.06}},
        red = {{-37.15, 1.62, 17.13},{-34.91, 1.62, 22.61},{-34.92, 1.62, 28.79},{-34.94, 1.62, 32.34}}
    }},
    huntress = { "d3e34a", "女猎手", false, {
        white = {{-34.37, 2.10, -18.24},{-34.00, 1.59, -22.19},{-34.00, 1.59, -28.04}},
        blue = {{30.19, 2.10, -18.30},{30.60, 1.52, -22.27},{30.60, 1.52, -28.12}},
        yellow = {{29.12, 2.10, 20.10},{28.77, 1.53, 24.07},{28.75, 1.53, 29.95}},
        red = {{-34.74, 2.10, 21.34},{-35.10, 1.62, 25.32},{-35.11, 1.62, 31.18}}
    }},
    gunner = { "8f41a0", "枪手", false, {
        white = {{-34.09, 1.59, -13.27},{-34.11, 1.59, -18.14},{-34.17, 1.59, -21.78},{-34.13, 1.59, -26.14}},
        blue = {{30.50, 1.52, -13.35},{30.45, 1.52, -18.20},{30.48, 1.52, -21.83},{30.46, 1.52, -26.21}},
        yellow = {{28.91, 1.53, 15.17},{28.90, 1.53, 20.03},{28.89, 1.53, 23.76},{28.85, 1.53, 28.04}},
        red = {{-34.97, 1.62, 16.39},{-34.96, 1.62, 21.22},{-35.00, 1.62, 25.00},{-35.03, 1.62, 29.26}}
    }},
    tac = { "d30ab3", "战术家", false, {
        white = {{-34.11, 1.59, -13.42},{-34.11, 1.59, -19.35},{-34.17, 1.59, -23.84},{-34.13, 1.59, -27.74}},
        blue = {{30.46, 1.52, -13.50},{30.45, 1.52, -19.44},{30.44, 1.52, -23.94},{30.46, 1.52, -27.76}},
        yellow = {{28.91, 1.53, 15.34},{28.90, 1.53, 21.25},{28.89, 1.53, 25.74},{28.85, 1.53, 29.65}},
        red = {{-34.97, 1.62, 16.51},{-34.96, 1.62, 22.46},{-35.00, 1.62, 26.95},{-35.03, 1.62, 30.80}}
    }},
    barba = { "6fe6eb", "野蛮人", false, {
        white = {{-33.96, 1.59, -13.36},{-33.95, 1.59, -16.64}},
        blue = {{30.59, 1.52, -13.41},{30.63, 1.52, -16.70}},
        yellow = {{28.81, 1.53, 15.22},{28.75, 1.53, 18.50}},
        red = {{-35.06, 1.62, 16.40},{-35.12, 1.62, 19.74}}
    }},
    pyro = { "ccbea2", "火法师", false, {
        white = {{-33.91, 1.59, -13.22},{-33.92, 1.59, -17.30},{-33.92, 1.59, -20.84},{-33.89, 1.59, -24.31}},
        blue = {{30.63, 1.52, -13.30},{30.68, 1.52, -17.37},{30.65, 1.52, -20.90},{30.64, 1.52, -24.39}},
        yellow = {{28.74, 1.53, 15.10},{28.74, 1.53, 19.17},{28.72, 1.53, 22.70},{28.75, 1.53, 26.17}},
        red = {{-35.18, 1.62, 16.32},{-35.15, 1.62, 20.40},{-35.16, 1.62, 23.93},{-35.14, 1.62, 27.42}}
    }},
    treant = { "cc8812", "树精", false, {
        white = {{-33.89, 1.59, -15.97},{-33.84, 1.59, -18.61},{-33.82, 1.59, -22.46},{-33.74, 1.59, -25.99},{-33.71, 1.59, -29.94}},
        blue = {{30.69, 1.52, -16.08},{30.76, 1.52, -18.58},{30.81, 1.52, -22.84},{30.83, 1.52, -26.09},{30.90, 1.52, -30.04}},
        yellow = {{28.65, 1.53, 17.88},{28.43, 1.53, 20.74},{28.51, 1.53, 24.99},{28.48, 1.53, 27.91},{28.50, 1.53, 31.85}},
        red = {{-35.21, 1.62, 19.14},{-35.29, 1.62, 21.88},{-35.43, 1.62, 26.26},{-35.41, 1.62, 29.12},{-35.41, 1.62, 33.07}}
    }},
    moon = { "eb2b2b", "月精灵", false, {
        white = {{-34.02, 1.59, -13.54},{-34.06, 1.59, -17.72},{-34.03, 1.59, -21.46},{-33.96, 1.59, -26.39}},
        blue = {{30.49, 1.52, -13.58},{30.56, 1.52, -17.79},{30.56, 1.52, -21.53},{30.60, 1.52, -26.46}},
        yellow = {{28.91, 1.53, 15.34},{28.86, 1.53, 19.60},{28.83, 1.53, 23.34},{28.79, 1.53, 28.25}},
        red = {{-35.04, 1.62, 16.62},{-34.99, 1.62, 20.80},{-35.03, 1.62, 24.56},{-35.06, 1.62, 29.46}}
    }},
    monk = { "8aaeac", "武僧", false, {
        white = {{-33.97, 1.59, -13.24},{-33.99, 1.59, -18.57},{-34.03, 1.59, -23.34},{-33.99, 1.59, -27.50}},
        blue = {{30.58, 1.52, -13.31},{30.56, 1.52, -18.65},{30.56, 1.52, -23.39},{30.58, 1.52, -27.53}},
        yellow = {{28.78, 1.53, 15.11},{28.77, 1.53, 20.51},{28.83, 1.53, 25.23},{28.79, 1.53, 29.33}},
        red = {{-35.09, 1.62, 16.42},{-35.09, 1.62, 21.74},{-35.03, 1.62, 26.42},{-35.06, 1.62, 30.57}}
    }},
    arti = { "9d6bed", "发明家", false, {
        white = {{-34.02, 1.59, -13.18},{-34.09, 1.59, -17.63},{-34.28, 2.30, -22.91},{-34.41, 2.30, -26.20},{-34.35, 2.30, -29.40}},
        blue = {{30.58, 1.52, -13.28},{30.45, 1.52, -17.71},{30.23, 2.30, -23.09},{30.13, 2.30, -26.32},{30.19, 2.30, -29.36}},
        yellow = {{28.81, 1.53, 15.05},{28.86, 1.53, 19.55},{29.08, 2.30, 24.82},{29.15, 2.30, 28.18},{29.08, 2.30, 31.19}},
        red = {{-35.04, 1.62, 16.27},{-35.02, 1.62, 20.76},{-34.82, 2.30, 26.12},{-34.70, 2.30, 29.44},{-34.81, 2.30, 32.39}}
    }},
    krump = { "7d7e5b", "圣诞恶魔", true, {
        white = {{-33.87, 1.59, -13.00},{-33.80, 1.59, -16.94},{-33.56, 2.15, -21.41}},
        blue = {{30.70, 1.52, -13.07},{30.68, 1.52, -16.82},{30.99, 2.15, -21.54}},
        yellow = {{28.65, 1.53, 14.91},{28.60, 1.53, 18.78},{28.33, 2.15, 23.15}},
        red = {{-35.24, 1.62, 16.13},{-35.19, 1.62, 19.95},{-35.53, 2.15, 24.38}}
    }},
    santa = { "b16a24", "圣诞老人", true, {
        white = {{-33.48, 1.59, -13.06},{-33.61, 1.59, -17.60}},
        blue = {{31.04, 1.52, -13.13},{30.97, 1.52, -17.67}},
        yellow = {{28.40, 1.53, 14.85},{28.38, 1.53, 19.47}},
        red = {{-35.46, 1.62, 16.15},{-35.50, 1.62, 20.70}}
    }}
}

-- 特殊物品生成数据 (按英雄类型)
local specialItemData = {
    pirate = {
        coin = {
            white = { start = {-17, 2.20, -22.57}, step = {3, 0, 0}, count = 3 },
            blue = { start = {47, 2.20, -22.57}, step = {3, 0, 0}, count = 3 },
            yellow = { start = {54, 2.20, 25}, step = {-3, 0, 0}, count = 3 },
            red = { start = {-10, 2.20, 26}, step = {-3, 0, 0}, count = 3 }
        }
    },
    tac = {
        tactic = {
            white = { positions = {{-13.66, 2.15, -22.18}, {-13.68, 2.05, -21.28}} },
            blue = { positions = {{50.88, 2.05, -21.88}, {50.89, 2.15, -22.55}} },
            yellow = { positions = {{50.16, 2.05, 24.21}, {50.18, 2.15, 24.97}} },
            red = { positions = {{-13.55, 2.05, 25.48}, {-13.54, 2.15, 26.18}} }
        }
    }
}

-- 颜色代码转换为完整颜色名称
local colorShortcuts = {w = "white", b = "blue", y = "yellow", r = "red"}

-- 通用物品生成函数
function afterSpawn(obj)
    if obj.tag ~= "Dice" and obj.tag ~= "Deck" and obj.hasAnyTag() == false then
        obj.setLock(true)
        return
    end
    
    if obj.hasTag('cue') then
        obj.flip()
        obj.lock() 
    elseif obj.hasTag('robo') then
        obj.flip()
    elseif obj.hasTag('doll') then
        obj.flip()
        obj.randomize()
        if obj.tag == 'Deck' then obj.deal(1) end
    else
        obj.randomize()
        if obj.tag == "Deck" then
            obj.flip()
            if not obj.hasTag('doll') then obj.deal(4) end
        end
    end
end

-- 特殊物品生成处理
function handleSpecialItems(obj, heroKey, colorKey)
    -- 检查该英雄是否有特殊物品处理
    if not specialItemData[heroKey] then return false end
    
    -- 遍历英雄的所有特殊物品类型
    for itemTag, itemConfig in pairs(specialItemData[heroKey]) do
        if obj.hasTag(itemTag) and itemConfig[colorKey] then
            local config = itemConfig[colorKey]
            
            -- 处理带有固定位置列表的情况 (如战术家标记)
            if config.positions then
                for _, pos in ipairs(config.positions) do
                    obj.takeObject({position = pos})
                end
                return true
            end
            
            -- 处理带有起始位置和步进值的情况 (如海盗硬币)
            if config.start and config.step and config.count then
                local pos = {config.start[1], config.start[2], config.start[3]}
                for i = 1, config.count do
                    obj.takeObject({position = pos})
                    pos[1] = pos[1] + config.step[1]
                    pos[2] = pos[2] + config.step[2]
                    pos[3] = pos[3] + config.step[3]
                end
                return true
            end
        end
    end
    
    return false
end

-- 统一的角色选择处理函数
function setupHero(heroKey, color)
    local hero = heroData[heroKey]
    if not hero then return end
    
    local colorLower = string.lower(color)
    local box = getObjectFromGUID(hero[1]) -- GUID
    local clonebag = box.clone({0, 5, 0})
    
    -- 放置通用物品
    for i = 1, 10 do
        clonebag.takeObject({
            position = commonPositions[colorLower][i],
            rotation = rotations[colorLower].base,
            callback_function = function(obj) afterSpawn(obj) end,
            smooth = false
        })
    end
    
    -- 放置英雄特定物品
    local tokenPositions = hero[4][colorLower]
    for i = 1, #tokenPositions do
        clonebag.takeObject({
            position = tokenPositions[i],
            rotation = rotations[colorLower].token,
            callback_function = function(obj)
                -- 尝试特殊处理，如果没有特殊处理则使用通用处理
                if not handleSpecialItems(obj, heroKey, colorLower) then
                    afterSpawn(obj)
                end
            end,
            smooth = false
        })
    end
    
    clonebag.destruct()
end

-- 初始化函数
function onLoad()
    -- 欢迎消息和说明
    local messages = {
        '欢迎来到侠技霸骰！',
        '请在左侧点击按钮选择英雄',
        '若需更改英雄，请先在左侧点击"重置玩家桌面"，再重新选择英雄\n',
        '英雄列表已按照难度排序，简单->困难，从左至右，从上至下\n',
        '\n',
        '"开始新回合"按钮为，增加1cp且抽一张牌。',
        '"抽牌"按钮为，仅抽一张牌。',
        '"重置玩家桌面"按钮为，将点击按钮的玩家桌面清空。\n',
        '如果发现部分物品无法清空，请将其放置在弃牌区再次点击重置玩家桌面按钮。',
        '如要查看英雄FAQ，建议右键克隆提示卡再右键解除锁定。\n',
        '作者：SpectrumTech'
    }
    
    for i, msg in ipairs(messages) do
        Wait.frames(function() broadcastToAll(msg) end, i * 200)
    end
    
    -- 为每个英雄创建按钮和点击函数
    for heroKey, hero in pairs(heroData) do
        local box = getObjectFromGUID(hero[1])
        
        -- 创建按钮
        box.createButton({
            click_function = heroKey.."Clicked",
            function_owner = self,
            label = "选择"..hero[2],
            position = {0, -1.4, 4},
            rotation = {0, 0, 0},
            width = hero[3] and 3100 or 2700,
            height = 700,
            font_size = 450
        })
        
        -- 创建点击函数
        _G[heroKey.."Clicked"] = function(obj, color, alt_click)
            setupHero(heroKey, color)
        end
    end
    
    -- 为兼容性创建旧函数
    for heroKey, _ in pairs(specialItemData) do
        for shortColor, fullColor in pairs(colorShortcuts) do
            _G["afterSpawn_"..heroKey.."_"..shortColor] = function(obj)
                if not handleSpecialItems(obj, heroKey, fullColor) then
                    afterSpawn(obj)
                end
            end
        end
    end
end
